name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  test-and-migrate:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: ci
          POSTGRES_PASSWORD: ci
          POSTGRES_DB: platform_admin
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd="pg_isready -U ci -d platform_admin"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
    
      - name: Secret scan (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: --path=. --verbose --redact --no-git
      
      - name: Fail if .env present in repo
        run: |
          set -euo pipefail
          # Inspecciona SOLO archivos rastreados por git (commiteados)
          if git ls-files | grep -E '(^|/)\.env($|(\.|/).*)'; then
            echo "ERROR: .env files must not be committed to the repository." >&2
            exit 1
          fi

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create venv (Python 3.12) + lock + deps (dev)
        run: |
          uv venv --python 3.12
          uv lock
          uv sync --frozen --group dev

      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U ci -d platform_admin && break
            sleep 2
          done

      # Preflight único: exige Postgres 17+, crea pgcrypto y schema control_plane si faltan
      - name: Preflight DB (assert version 17+, ensure pgcrypto & schema)
        env: { PGPASSWORD: ci }
        run: |
          psql "postgresql://ci@localhost:5432/platform_admin" -v ON_ERROR_STOP=1 <<'SQL'
          DO $$
          DECLARE ver int := current_setting('server_version_num')::int;
          BEGIN
            IF ver < 170000 THEN
              RAISE EXCEPTION 'PostgreSQL 17+ requerido (detectado %)', current_setting('server_version');
            END IF;
          END;
          $$;
          CREATE EXTENSION IF NOT EXISTS pgcrypto;
          CREATE SCHEMA IF NOT EXISTS control_plane;
          SQL

      - name: Alembic upgrade head
        env:
          CONTROL_PLANE_DATABASE_URL: postgresql+psycopg://ci:ci@localhost:5432/platform_admin
        run: uv run alembic upgrade head
    
      - name: Assert no secrets stored in db_secret_ref
        env:
          PGPASSWORD: ci
        run: |
          set -euo pipefail
          SQL="
          SELECT COUNT(*) FROM control_plane.tenants
          WHERE deleted_at IS NULL AND (
            -- Palabras típicas de secretos
            db_secret_ref ~* '(password|passwd|pwd|token|secret|apikey|api[_-]?key|bearer|aws_secret_access_key)'
            OR -- Evitar URLs/DSN pegados
            db_secret_ref ~ '://'
            OR -- Evitar usuario@host patrones típicos
            db_secret_ref ~ '@'
          );"
          CNT=$(psql "postgresql://ci@localhost:5432/platform_admin" -tAc "$SQL")
          echo "suspicious_refs=$CNT"
          if [ "$CNT" -gt 0 ]; then
            echo "ERROR: Encontradas referencias sospechosas en control_plane.tenants.db_secret_ref (posibles secretos en claro)." >&2
            exit 1
          fi

      - name: Run tests (si existen)
        env:
          CONTROL_PLANE_DATABASE_URL: postgresql+psycopg://ci:ci@localhost:5432/platform_admin
        run: |
          if [ -d tests ] || ls -1 test_*.py 2>/dev/null | grep -q .; then
            uv run pytest -q
          else
            echo "No hay tests; omitiendo."
          fi

  docker-build:
    runs-on: ubuntu-latest
    needs: test-and-migrate
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: control-plane:ci
